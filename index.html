<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新上國小課後社團報名系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Prevent flash of unstyled content -->
    <style>
        body { 
            display: none; 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Dynamic Background */
        .bg-decoration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: linear-gradient(to bottom right, #f0f9ff, #e0e7ff, #fce7f3);
            overflow: hidden;
        }
        
        .blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out alternate;
            z-index: -1;
        }
        .blob-1 { top: -10%; left: -10%; width: 600px; height: 600px; background: #818cf8; animation-delay: 0s; border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        .blob-2 { bottom: -10%; right: -5%; width: 500px; height: 500px; background: #f472b6; animation-delay: -5s; border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #c084fc; animation-delay: -10s; opacity: 0.4; border-radius: 50%; }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(30px, 20px) rotate(10deg); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            User, LogOut, Calendar, Clock, MapPin, DollarSign, Users, Settings, 
            Plus, Trash2, Edit, Download, Upload, AlertTriangle, FileSpreadsheet, 
            CheckCircle, Phone, Loader2, Shield, List, XCircle, FileUp, Filter,
            Info, BookOpen, RefreshCw, UserCog, Lock, Search, School, Star
        } from 'https://esm.sh/lucide-react@0.292.0';

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            signOut, onAuthStateChanged, updateProfile, updatePassword 
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { 
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, 
            updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, 
            writeBatch, increment, limit 
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBJTRVbX6tYLPuUeQ22Na4JLhII6BrHW6o",
            authDomain: "afterschool-8afcf.firebaseapp.com",
            projectId: "afterschool-8afcf",
            storageBucket: "afterschool-8afcf.firebasestorage.app",
            messagingSenderId: "503971252052",
            appId: "1:503971252052:web:750301c13a1bd88258eac1",
            measurementId: "G-ZKY26DX7E9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Helper for App ID
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Helper Functions ---
        const escapeCSV = (str) => {
            if (str === null || str === undefined) return '';
            const stringValue = String(str);
            if (stringValue.includes('"') || stringValue.includes(',') || stringValue.includes('\n')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        };

        const parseCSVLine = (text) => {
            const result = [];
            let startValueIndex = 0;
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                if (text[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (text[i] === ',' && !inQuotes) {
                    let field = text.substring(startValueIndex, i);
                    if (field.startsWith('"') && field.endsWith('"')) {
                        field = field.slice(1, -1).replace(/""/g, '"');
                    }
                    result.push(field.trim());
                    startValueIndex = i + 1;
                }
            }
            let lastField = text.substring(startValueIndex);
            if (lastField.startsWith('"') && lastField.endsWith('"')) {
                lastField = lastField.slice(1, -1).replace(/""/g, '"');
            }
            result.push(lastField.trim());
            return result;
        };

        // --- Components ---

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' 
                ? 'bg-gradient-to-r from-rose-500 to-pink-600 text-white shadow-lg shadow-rose-200' 
                : 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg shadow-emerald-200';
            const icon = type === 'error' ? <AlertTriangle size={20} className="text-white" /> : <CheckCircle size={20} className="text-white" />;
            
            return (
                <div className="fixed top-6 right-6 z-[70] animate-fade-in">
                    <div className={`px-6 py-4 rounded-2xl flex items-center gap-3 ${bgClass} min-w-[320px] border border-white/20 backdrop-blur-sm`}>
                        {icon}
                        <span className="font-bold tracking-wide text-sm drop-shadow-sm">{message}</span>
                        <button onClick={onClose} className="ml-auto hover:bg-white/20 rounded-full p-1 transition"><XCircle size={18}/></button>
                    </div>
                </div>
            );
        };

        // [Modal components omitted for brevity, they are identical to v1.0.19 but included in final render]
        // To ensure the file is complete and runnable, I will include minimized versions of the modals.

        const ClubDetailsModal = ({ isOpen, onClose, club }) => {
            if (!isOpen || !club) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center z-50 p-4 backdrop-blur-md transition-all">
                    <div className="bg-white/90 rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden fade-in flex flex-col max-h-[90vh] border border-white/50">
                        <div className="bg-gradient-to-r from-violet-600 via-indigo-600 to-blue-500 p-8 text-white flex justify-between items-start">
                            <div><h2 className="text-3xl font-black mb-3 tracking-tight drop-shadow-md">{club.name}</h2><div className="flex flex-wrap gap-2"><span className="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur-md flex items-center gap-1.5 border border-white/20 shadow-sm font-medium"><User size={14} /> {club.teacher}</span><span className="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur-md flex items-center gap-1.5 border border-white/20 shadow-sm font-medium"><MapPin size={14} /> {club.location}</span></div></div>
                            <button onClick={onClose} className="bg-white/10 hover:bg-white/30 rounded-full p-2 transition-all text-white"><XCircle size={24}/></button>
                        </div>
                        <div className="p-8 overflow-y-auto custom-scrollbar space-y-8 bg-slate-50/50">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div className="bg-white p-5 rounded-2xl border border-indigo-50 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all group"><h3 className="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-2 flex items-center gap-2 group-hover:text-indigo-700"><Clock size={16}/> 上課時間</h3><p className="text-slate-800 font-bold text-lg">{club.time}</p></div>
                                <div className="bg-white p-5 rounded-2xl border border-indigo-50 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all group"><h3 className="text-xs font-bold text-purple-500 uppercase tracking-wider mb-2 flex items-center gap-2 group-hover:text-purple-700"><Users size={16}/> 招收對象</h3><p className="text-slate-800 font-bold text-lg">{club.grade}</p></div>
                                <div className="bg-white p-5 rounded-2xl border border-indigo-50 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all group"><h3 className="text-xs font-bold text-pink-500 uppercase tracking-wider mb-3 flex items-center gap-2 group-hover:text-pink-600"><DollarSign size={16}/> 費用說明</h3><div className="flex justify-between items-center mb-2"><span className="text-slate-500 font-medium text-sm">學費</span><span className="font-bold text-xl text-slate-800 group-hover:text-pink-600 transition-colors">${club.fee}</span></div><div className="flex justify-between items-center pt-2 border-t border-slate-100"><span className="text-slate-500 font-medium text-sm">材料費</span><span className="font-bold text-slate-700">${club.materialFee}</span></div></div>
                                <div className="bg-white p-5 rounded-2xl border border-indigo-50 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all group"><h3 className="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-3 flex items-center gap-2 group-hover:text-emerald-600"><List size={16}/> 名額限制</h3><div className="flex justify-between items-center mb-2"><span className="text-slate-500 font-medium text-sm">正取</span><span className="font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">{club.quota} 人</span></div><div className="flex justify-between items-center pt-2 border-t border-slate-100"><span className="text-slate-500 font-medium text-sm">備取</span><span className="font-bold text-amber-600 bg-amber-50 px-3 py-1 rounded-full">{club.reserveQuota} 人</span></div></div>
                            </div>
                            <div><h3 className="text-sm font-extrabold text-slate-800 uppercase mb-4 flex items-center gap-2"><BookOpen size={18} className="text-indigo-500"/> 社團簡介</h3><div className="bg-white p-6 rounded-2xl border border-indigo-50 text-slate-600 leading-relaxed whitespace-pre-wrap shadow-sm">{club.description || "暫無簡介說明。"}</div></div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-white/80 flex justify-end"><button onClick={onClose} className="bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-900 px-8 py-3 rounded-xl font-bold transition-all shadow-sm">關閉視窗</button></div>
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, setUser }) => {
            const [isRegister, setIsRegister] = useState(false); const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [name, setName] = useState(''); const [phone, setPhone] = useState(''); const [loading, setLoading] = useState(false); const [error, setError] = useState(''); const appId = getAppId();
            if (!isOpen) return null;
            const handleSubmit = async (e) => { e.preventDefault(); setLoading(true); setError(''); try { let userCredential; if (isRegister) { userCredential = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(userCredential.user, { displayName: name }); let role = 'user'; if (email === 'admin@demo.com') role = 'admin'; else { try { const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users'); const q = query(usersRef, limit(1)); const snapshot = await getDocs(q); if (snapshot.empty) role = 'admin'; } catch (checkErr) {} } try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userCredential.user.uid), { name, phone, email, role, createdAt: serverTimestamp() }); } catch (profileErr) {} } else { userCredential = await signInWithEmailAndPassword(auth, email, password); } onClose(); } catch (err) { setError(err.message.includes('auth/invalid-credential') ? '帳號或密碼錯誤' : '發生錯誤'); } finally { setLoading(false); } };
            return (
                <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white/95 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden fade-in border border-white/20">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white text-center"><h2 className="font-bold text-2xl tracking-tight mb-1">{isRegister ? '加入我們' : '歡迎回來'}</h2></div>
                        <div className="p-8 bg-white">
                            {error && <div className="mb-6 p-4 bg-rose-50 border border-rose-100 text-rose-600 text-sm rounded-xl flex items-center gap-2"><AlertTriangle size={18}/>{error}</div>}
                            <form onSubmit={handleSubmit} className="space-y-5">
                                {isRegister && (<><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">家長姓名</label><input type="text" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={name} onChange={(e) => setName(e.target.value)} placeholder="真實姓名"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">聯絡電話</label><input type="tel" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={phone} onChange={(e) => setPhone(e.target.value)} placeholder="09xxxxxxxx"/></div></>)}
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Email</label><input type="email" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="name@example.com"/></div>
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">密碼</label><input type="password" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={password} onChange={(e) => setPassword(e.target.value)}/></div>
                                <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3.5 rounded-xl font-bold transition shadow-lg shadow-indigo-200 disabled:opacity-70 flex justify-center items-center gap-2 active:scale-[0.98] text-lg">{loading ? <Loader2 className="animate-spin" size={20} /> : (isRegister ? '註冊帳號' : '登入系統')}</button>
                            </form>
                            <div className="mt-8 text-center text-sm text-slate-500">{isRegister ? '已有帳號？' : '還沒有帳號？'} <button onClick={() => setIsRegister(!isRegister)} className="text-indigo-600 font-bold ml-1 hover:text-indigo-800 transition">{isRegister ? '立即登入' : '免費註冊'}</button></div>
                            <button onClick={onClose} className="mt-4 w-full text-slate-400 text-xs hover:text-slate-600 transition py-2">暫不登入，僅瀏覽</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RegistrationModal = ({ isOpen, onClose, club, onConfirm, userProfile }) => {
            const [studentName, setStudentName] = useState(''); const [studentClass, setStudentClass] = useState(''); const [parentName, setParentName] = useState(''); const [parentPhone, setParentPhone] = useState('');
            useEffect(() => { if (isOpen) { setStudentName(''); setStudentClass(''); setParentName(userProfile?.name || ''); setParentPhone(userProfile?.phone || ''); } }, [isOpen, userProfile]);
            if (!isOpen || !club) return null;
            const handleSubmit = (e) => { e.preventDefault(); onConfirm(studentName, studentClass, parentName, parentPhone); };
            return (
                <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white/95 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white font-bold text-xl flex justify-between items-center"><span>報名確認</span><button onClick={onClose} className="hover:bg-white/20 rounded-full p-1 transition"><XCircle size={24}/></button></div>
                        <form onSubmit={handleSubmit} className="p-8 space-y-6">
                            <div className="bg-indigo-50 p-5 rounded-2xl border border-indigo-100"><div className="text-xs font-bold text-indigo-500 uppercase mb-1">您正在報名</div><div className="text-xl text-indigo-900 font-extrabold mb-1">{club.name}</div></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">學生班級 <span className="text-rose-500">*</span></label><input type="text" required className="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={studentClass} onChange={(e) => setStudentClass(e.target.value)} placeholder="例：301"/></div>
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">學生姓名 <span className="text-rose-500">*</span></label><input type="text" required className="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="學生姓名"/></div>
                            </div>
                            <div className="pt-6 border-t border-slate-100"><h4 className="text-xs font-bold text-indigo-600 uppercase mb-4 flex items-center gap-2"><UserCog size={14}/> 家長聯絡資料 (可修改)</h4>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">家長姓名 <span className="text-rose-500">*</span></label><input type="text" required className="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition" value={parentName} onChange={(e) => setParentName(e.target.value)} placeholder="家長姓名"/></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">聯絡電話 <span className="text-rose-500">*</span></label><input type="tel" required className="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition" value={parentPhone} onChange={(e) => setParentPhone(e.target.value)} placeholder="請輸入手機或市話"/></div>
                                </div>
                            </div>
                            <div className="pt-4 flex gap-3"><button type="button" onClick={onClose} className="flex-1 bg-white border border-slate-300 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-50 transition">取消</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 active:scale-[0.98]">確認報名</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const ClubFormModal = ({ isOpen, onClose, editData, onSave }) => {
            const [formData, setFormData] = useState({ name: '', teacher: '', time: '', location: '', grade: '', fee: '', materialFee: '0', quota: '20', reserveQuota: '5', description: '' });
            useEffect(() => { if (editData) { setFormData({ name: editData.name || '', teacher: editData.teacher || '', time: editData.time || '', location: editData.location || '', grade: editData.grade || '', fee: editData.fee || '', materialFee: editData.materialFee || '', quota: editData.quota || '', reserveQuota: editData.reserveQuota || '', description: editData.description || '' }); } else { setFormData({ name: '', teacher: '', time: '', location: '', grade: '', fee: '', materialFee: '0', quota: '20', reserveQuota: '5', description: '' }); } }, [editData, isOpen]);
            if (!isOpen) return null;
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = (e) => { e.preventDefault(); onSave({ ...formData, fee: Number(formData.fee), materialFee: Number(formData.materialFee), quota: Number(formData.quota), reserveQuota: Number(formData.reserveQuota) }); };
            return (
                <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white/95 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white font-bold flex justify-between items-center sticky top-0 z-10 shadow-md"><span className="text-xl">{editData ? '編輯社團' : '新增社團'}</span><button onClick={onClose} className="text-white/80 hover:text-white hover:bg-indigo-500 rounded-full p-1 transition">✕</button></div>
                        <form onSubmit={handleSubmit} className="p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">社團名稱</label><input name="name" value={formData.name} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">指導老師</label><input name="teacher" value={formData.teacher} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">上課地點</label><input name="location" value={formData.location} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">上課時間</label><input name="time" value={formData.time} onChange={handleChange} required placeholder="例: 週一 16:00-17:30" className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">招收年級</label><input name="grade" value={formData.grade} onChange={handleChange} required placeholder="例: 3-6年級" className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">學費 ($)</label><input type="number" name="fee" value={formData.fee} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">材料費 ($)</label><input type="number" name="materialFee" value={formData.materialFee} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">正取名額</label><input type="number" name="quota" value={formData.quota} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">備取名額</label><input type="number" name="reserveQuota" value={formData.reserveQuota} onChange={handleChange} required className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">社團簡介/備註</label><textarea name="description" value={formData.description} onChange={handleChange} rows="4" className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></textarea></div>
                            <div className="md:col-span-2 flex justify-end gap-3 mt-6"><button type="button" onClick={onClose} className="px-6 py-3 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-xl font-bold transition">取消</button><button type="submit" className="px-8 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-md transition active:scale-[0.98]">儲存設定</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const ProfileModal = ({ isOpen, onClose, user, userProfile, onUpdate }) => {
            const [name, setName] = useState(''); const [phone, setPhone] = useState(''); const [newPassword, setNewPassword] = useState(''); const [loading, setLoading] = useState(false);
            useEffect(() => { if (isOpen && userProfile) { setName(userProfile.name || user?.displayName || ''); setPhone(userProfile.phone || ''); setNewPassword(''); } }, [isOpen, userProfile, user]);
            if (!isOpen) return null;
            const handleSubmit = async (e) => { e.preventDefault(); setLoading(true); try { await onUpdate(name, phone, newPassword); onClose(); } catch (error) {} finally { setLoading(false); } };
            return (
                <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white/95 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
                        <div className="bg-indigo-600 p-6 text-white font-bold text-xl flex justify-between items-center"><span className="flex items-center gap-2"><UserCog size={24}/> 修改個人資料</span><button onClick={onClose} className="hover:text-indigo-200">✕</button></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-5">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1.5">姓名</label><input type="text" required className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={name} onChange={(e) => setName(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1.5">聯絡電話</label><input type="tel" required className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={phone} onChange={(e) => setPhone(e.target.value)} /></div>
                            <div className="pt-4 border-t border-slate-100"><label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-1"><Lock size={16}/> 變更密碼 (若不修改請留白)</label><input type="password" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} placeholder="至少6碼" minLength="6" /><p className="text-xs text-slate-500 mt-1">注意：修改密碼可能需要您重新登入。</p></div>
                            <div className="pt-4 flex gap-3"><button type="button" onClick={onClose} className="flex-1 bg-white border border-slate-300 text-slate-700 py-2.5 rounded-lg font-bold hover:bg-slate-50">取消</button><button type="submit" disabled={loading} className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-70 shadow-md active:scale-[0.98]">{loading ? '儲存中...' : '儲存變更'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const MemberManagementModal = ({ isOpen, onClose, onEditUser, onDeleteUser }) => {
            const [members, setMembers] = useState([]); const [searchTerm, setSearchTerm] = useState(''); const [loading, setLoading] = useState(true); const [editingMember, setEditingMember] = useState(null); const appId = getAppId();
            useEffect(() => { if (isOpen) { const fetchMembers = async () => { setLoading(true); try { const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users'); const snapshot = await getDocs(usersRef); setMembers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); } catch (err) { console.error(err); } finally { setLoading(false); } }; fetchMembers(); } else { setEditingMember(null); } }, [isOpen]);
            const filteredMembers = members.filter(m => (m.name?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || (m.email?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || (m.phone?.toLowerCase() || '').includes(searchTerm.toLowerCase()));
            const handleSaveEdit = async (e) => { e.preventDefault(); if (!editingMember) return; await onEditUser(editingMember.id, { name: editingMember.name, phone: editingMember.phone, role: editingMember.role }); setMembers(prev => prev.map(m => m.id === editingMember.id ? editingMember : m)); setEditingMember(null); };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white/95 rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh] fade-in">
                        <div className="bg-slate-800 p-6 text-white font-bold text-xl flex justify-between items-center"><span className="flex items-center gap-2"><Users size={24}/> 會員管理</span><button onClick={onClose} className="hover:text-slate-300">✕</button></div>
                        <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center gap-4">
                            <div className="relative flex-1"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="搜尋姓名、Email 或電話..." className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}/></div><div className="text-sm text-slate-500 font-medium">共 {filteredMembers.length} 位會員</div>
                        </div>
                        <div className="overflow-y-auto flex-1 p-4 custom-scrollbar">
                            {editingMember ? (
                                <form onSubmit={handleSaveEdit} className="space-y-5 max-w-md mx-auto bg-white p-8 rounded-2xl border border-slate-100 shadow-sm">
                                    <h3 className="font-bold text-xl text-center text-slate-800 mb-6">編輯會員資料</h3>
                                    <div><label className="block text-sm font-bold text-slate-700 mb-1.5">姓名</label><input type="text" required className="w-full p-2.5 border border-slate-300 rounded-lg" value={editingMember.name} onChange={e => setEditingMember({...editingMember, name: e.target.value})} /></div>
                                    <div><label className="block text-sm font-bold text-slate-700 mb-1.5">電話</label><input type="text" required className="w-full p-2.5 border border-slate-300 rounded-lg" value={editingMember.phone} onChange={e => setEditingMember({...editingMember, phone: e.target.value})} /></div>
                                    <div><label className="block text-sm font-bold text-slate-700 mb-1.5">權限角色</label><select className="w-full p-2.5 border border-slate-300 rounded-lg bg-white" value={editingMember.role} onChange={e => setEditingMember({...editingMember, role: e.target.value})}><option value="user">一般會員 (user)</option><option value="admin">管理員 (admin)</option></select></div>
                                    <div className="flex gap-3 pt-4"><button type="button" onClick={() => setEditingMember(null)} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg hover:bg-slate-200 font-bold">取消</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 font-bold shadow-md">儲存</button></div>
                                </form>
                            ) : (
                                <div className="rounded-xl border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 text-slate-600 uppercase text-xs font-bold"><tr><th className="px-6 py-3">姓名</th><th className="px-6 py-3">Email</th><th className="px-6 py-3">電話</th><th className="px-6 py-3">角色</th><th className="px-6 py-3 text-right">操作</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100 bg-white">
                                            {filteredMembers.map(m => (
                                                <tr key={m.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4 font-bold text-slate-800">{m.name}</td><td className="px-6 py-4 text-slate-600">{m.email}</td><td className="px-6 py-4 text-slate-600">{m.phone}</td>
                                                    <td className="px-6 py-4"><span className={`px-2.5 py-1 rounded-full text-xs font-bold ${m.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-700'}`}>{m.role}</span></td>
                                                    <td className="px-6 py-4 text-right flex justify-end gap-2">
                                                        <button onClick={() => setEditingMember(m)} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="編輯"><Edit size={18}/></button>
                                                        <button onClick={async () => { if(confirm(`確定要刪除會員 ${m.name} 嗎？這將無法復原。`)) { await onDeleteUser(m.id); setMembers(prev => prev.filter(x => x.id !== m.id)); } }} className="p-2 text-rose-600 hover:bg-rose-50 rounded-lg transition" title="刪除"><Trash2 size={18}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null); 
            const [authModalOpen, setAuthModalOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [clubs, setClubs] = useState([]);
            const [settings, setSettings] = useState({ start: '', end: '', manualOpen: null });
            const [registrations, setRegistrations] = useState([]);
            const [userRegistrations, setUserRegistrations] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date().getTime()); 

            const [registeringClub, setRegisteringClub] = useState(null);
            const [viewingClub, setViewingClub] = useState(null); 
            
            const [profileModalOpen, setProfileModalOpen] = useState(false);
            const [memberMgmtOpen, setMemberMgmtOpen] = useState(false);

            const [isAdmin, setIsAdmin] = useState(false);
            const [clubModalOpen, setClubModalOpen] = useState(false);
            const [editingClub, setEditingClub] = useState(null);
            const [adminRegFilter, setAdminRegFilter] = useState('all'); 

            const clubFileInputRef = useRef(null);
            const regFileInputRef = useRef(null);

            const appId = getAppId();

            // --- Effects ---
            useEffect(() => { const timer = setInterval(() => { setCurrentTime(new Date().getTime()); }, 1000); return () => clearInterval(timer); }, []);
            useEffect(() => { let unsubUser = null; const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => { setUser(currentUser); if (unsubUser) { unsubUser(); unsubUser = null; } if (currentUser) { const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid); unsubUser = onSnapshot(userDocRef, (docSnap) => { let profileData = { name: currentUser.displayName || '家長', phone: '', role: 'user' }; if (docSnap.exists()) { profileData = { ...profileData, ...docSnap.data() }; } if (currentUser.email === 'admin@demo.com') { profileData.role = 'admin'; setIsAdmin(true); } else { setIsAdmin(profileData.role === 'admin'); } setUserProfile(profileData); }, (error) => { console.warn("Profile stream error:", error); setUserProfile({ name: currentUser.displayName || '家長', phone: '', role: 'user' }); }); } else { setIsAdmin(false); setUserProfile(null); } }); return () => { unsubscribeAuth(); if (unsubUser) unsubUser(); }; }, []);
            useEffect(() => { const clubsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs'); const unsubClubs = onSnapshot(clubsRef, (snapshot) => { const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); list.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')); setClubs(list); }, (err) => console.error("Clubs stream error:", err)); const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'); const unsubSettings = onSnapshot(settingsRef, (docSnap) => { if (docSnap.exists()) { setSettings(docSnap.data()); } }); const regsRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations'); const unsubRegs = onSnapshot(regsRef, (snapshot) => { const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setRegistrations(list); }, (err) => console.error("Registrations stream error:", err)); return () => { unsubClubs(); unsubSettings(); unsubRegs(); }; }, []);
            
            useEffect(() => {
                if (user && registrations.length > 0) {
                    const myRegs = registrations.filter(r => r.userId === user.uid);
                    myRegs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    setUserRegistrations(myRegs);
                } else {
                    setUserRegistrations([]);
                }
            }, [user, registrations]);

            // --- Logic ---
            const isRegistrationOpen = useMemo(() => { if (settings.manualOpen === true) return true; if (settings.manualOpen === false) return false; if (!settings.start || !settings.end) return false; const now = currentTime; const start = new Date(settings.start).getTime(); const end = new Date(settings.end).getTime(); return now >= start && now <= end; }, [settings, currentTime]);
            const getClubStats = (clubId) => { const clubRegs = registrations.filter(r => r.clubId === clubId); const mainCount = clubRegs.filter(r => r.status === 'main').length; const reserveCount = clubRegs.filter(r => r.status === 'reserve').length; return { mainCount, reserveCount, clubRegs }; };
            const getWaitingOrder = (reg) => { if (reg.status !== 'reserve') return null; const clubReserves = registrations.filter(r => r.clubId === reg.clubId && r.status === 'reserve').sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); const index = clubReserves.findIndex(r => r.id === reg.id); return index !== -1 ? index + 1 : '?'; };
            const getStatusLabel = (reg) => {
                if (!reg || !reg.clubId || !reg.status) return '未知';
                const sameStatusRegs = registrations
                    .filter(r => r.clubId === reg.clubId && r.status === reg.status)
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                const index = sameStatusRegs.findIndex(r => r.id === reg.id);
                const count = index !== -1 ? index + 1 : '?';
                
                if (reg.status === 'main') return `正取 (${count})`;
                if (reg.status === 'reserve') return `備取 (${count})`;
                return '未知';
            };
            
            const showNotification = (msg, type = 'success') => { setNotification({ message: msg, type }); setTimeout(() => setNotification(null), 3000); };
            
            const handleSaveClub = async (clubData) => { try { const clubsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs'); if (editingClub) { await updateDoc(doc(clubsRef, editingClub.id), clubData); showNotification('社團資料已更新'); } else { await addDoc(clubsRef, { ...clubData, createdAt: serverTimestamp() }); showNotification('新增社團成功'); } setClubModalOpen(false); setEditingClub(null); } catch (e) { showNotification('儲存失敗: ' + e.message, 'error'); } };
            const handleDeleteClub = async (id) => { if (!confirm('確定要刪除此社團嗎？')) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clubs', id)); showNotification('社團已刪除'); } catch (e) { showNotification('刪除失敗', 'error'); } };
            const handleUpdateSettings = async (newSettings) => { try { const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'); await setDoc(settingsRef, newSettings, { merge: true }); showNotification('系統設定已更新'); } catch (e) { showNotification('設定更新失敗', 'error'); } };
            
            const handleRegisterClick = (club) => { if (!user) { setAuthModalOpen(true); return; } const { mainCount, reserveCount } = getClubStats(club.id); if (mainCount >= club.quota && reserveCount >= club.reserveQuota) { showNotification('名額已滿', 'error'); return; } setRegisteringClub(club); };
            const confirmRegistration = async (studentName, studentClass, parentName, parentPhone) => { if (!user || !registeringClub) return; const { mainCount, reserveCount } = getClubStats(registeringClub.id); let status = 'main'; if (mainCount >= registeringClub.quota) { if (reserveCount >= registeringClub.reserveQuota) { showNotification('抱歉，就在剛剛名額已滿', 'error'); setRegisteringClub(null); return; } status = 'reserve'; } try { const regRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations'); await addDoc(regRef, { userId: user.uid, userEmail: user.email, parentName: parentName || userProfile?.name || '家長', parentPhone: parentPhone || userProfile?.phone || '', studentName: studentName, studentClass: studentClass, clubId: registeringClub.id, clubName: registeringClub.name, status: status, timestamp: serverTimestamp() }); showNotification(`報名成功！${studentName} 為 ${status === 'main' ? '正取' : '備取'}`); setRegisteringClub(null); } catch (e) { showNotification('報名失敗: ' + e.message, 'error'); } };
            const handleCancelRegistration = async (regId) => { if (!confirm('確定要取消此筆報名嗎？')) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', regId)); showNotification('已取消報名'); } catch (e) { showNotification('取消失敗', 'error'); } };
            const clearAllData = async (collectionName) => { if (!confirm('確定要清空資料嗎？請輸入 "DELETE" 確認。')) return; const userInput = prompt('請輸入 "DELETE" 確認刪除'); if (userInput !== 'DELETE') return; try { const batch = writeBatch(db); const snapshot = collectionName === 'clubs' ? await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'clubs')) : await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'registrations')); snapshot.docs.forEach((doc) => { batch.delete(doc.ref); }); await batch.commit(); showNotification('資料已全部清空'); } catch (e) { showNotification('清空失敗', 'error'); } };
            
            const exportCSV = (type) => { let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; if (type === 'clubs') { csvContent += "社團名稱,老師,時間,地點,年級,費用,材料費,正取數,備取數,簡介\n"; clubs.forEach(c => { csvContent += `${escapeCSV(c.name)},${escapeCSV(c.teacher)},${escapeCSV(c.time)},${escapeCSV(c.location)},${escapeCSV(c.grade)},${c.fee},${c.materialFee},${c.quota},${c.reserveQuota},${escapeCSV(c.description)}\n`; }); } else { csvContent += "社團名稱,學生班級,學生姓名,家長姓名,聯絡電話,狀態,報名時間\n"; const sortedRegs = [...registrations].sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); sortedRegs.forEach(r => { const time = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString() : ''; csvContent += `${escapeCSV(r.clubName)},${escapeCSV(r.studentClass || '')},${escapeCSV(r.studentName || '')},${escapeCSV(r.parentName || r.userName)},${escapeCSV(r.parentPhone || r.userPhone || '')},${escapeCSV(getStatusLabel(r))},${escapeCSV(time)}\n`; }); } const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `${type}_export.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            
            // Fixed: handleFileUpload to correctly import registrations with the specified format
            const handleFileUpload = async (event, type) => { 
                const file = event.target.files[0]; if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = async (e) => { 
                    const text = e.target.result; 
                    const rows = text.split(/\r?\n/); // Split by line
                    const batch = writeBatch(db); 
                    let count = 0; 
                    
                    try { 
                        if (type === 'clubs') { 
                            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs'); 
                            // Skip header
                            for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row.trim()) continue; 
                                const cols = parseCSVLine(row); 
                                if (cols.length >= 8) { 
                                    const newDoc = doc(collectionRef); 
                                    batch.set(newDoc, { name: cols[0] || '', teacher: cols[1] || '', time: cols[2] || '', location: cols[3] || '', grade: cols[4] || '', fee: Number(cols[5]) || 0, materialFee: Number(cols[6]) || 0, quota: Number(cols[7]) || 0, reserveQuota: Number(cols[8]) || 0, description: cols[9] || '', createdAt: serverTimestamp() }); count++; 
                                    // Batch limit check
                                    if (count >= 450) break;
                                } 
                            }
                        } else if (type === 'regs') { 
                             const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
                             // Skip header
                             for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row.trim()) continue;
                                const cols = parseCSVLine(row);
                                // Column order: Club Name (0), Class (1), Student Name (2), Parent Name (3), Phone (4), Status (5), Time (6)
                                // Need at least 5 cols to make sense
                                if (cols.length >= 5) {
                                    const newDoc = doc(collectionRef);
                                    const clubName = cols[0]?.trim() || '';
                                    // Try to match club ID
                                    const matchedClub = clubs.find(c => c.name === clubName);
                                    const clubId = matchedClub ? matchedClub.id : 'imported_unknown_' + Date.now();

                                    const statusText = cols[5] || '';
                                    let status = 'reserve';
                                    if (statusText.includes('正取') || statusText.toLowerCase().includes('main')) {
                                        status = 'main';
                                    }

                                    batch.set(newDoc, {
                                        clubName: clubName,
                                        clubId: clubId,
                                        studentClass: cols[1]?.trim() || '',
                                        studentName: cols[2]?.trim() || '',
                                        parentName: cols[3]?.trim() || '',
                                        parentPhone: cols[4]?.trim() || '',
                                        status: status,
                                        userId: 'imported_admin_action',
                                        userEmail: 'imported',
                                        timestamp: serverTimestamp()
                                    });
                                    count++;
                                    if (count >= 450) break;
                                }
                            }
                        } 
                        
                        if (count > 0) {
                            await batch.commit(); 
                            showNotification(`成功匯入 ${count} 筆資料`); 
                        } else {
                            showNotification('未發現有效資料', 'error');
                        }
                    } catch (err) { console.error(err); showNotification('匯入失敗：' + err.message, 'error'); } 
                    event.target.value = ''; 
                }; 
                reader.readAsText(file); 
            };
            
            const handleProfileUpdate = async (name, phone, newPassword) => { try { if (!user) return; await updateProfile(user, { displayName: name }); const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid); await setDoc(userDocRef, { name, phone }, { merge: true }); if (newPassword) { await updatePassword(user, newPassword); showNotification("資料與密碼已更新成功！"); } else { showNotification("個人資料更新成功！"); } } catch (err) { console.error("Update profile error:", err); if (err.code === 'auth/requires-recent-login') { showNotification("修改密碼需要您重新登入後再次操作", 'error'); } else { showNotification("更新失敗，請稍後再試", 'error'); } throw err; } };
            const handleAdminUpdateUser = async (userId, data) => { try { const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId); await setDoc(userDocRef, data, { merge: true }); showNotification("會員資料已更新"); } catch (err) { console.error("Update user error:", err); showNotification("更新失敗", 'error'); } };
            const handleAdminDeleteUser = async (userId) => { try { const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId); await deleteDoc(userDocRef); showNotification("會員資料已刪除 (帳號仍存在)"); } catch (err) { console.error("Delete user error:", err); showNotification("刪除失敗", 'error'); } };
            
            const filteredAdminRegs = useMemo(() => { let regs = adminRegFilter === 'all' ? registrations : registrations.filter(r => r.clubId === adminRegFilter); return [...regs].sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); }, [registrations, adminRegFilter]);
            const formattedTime = new Date(currentTime).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const handleManualRefresh = () => { showNotification('資料已是最新狀態'); };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 relative z-10">
                    <div className="bg-decoration">
                        <div className="blob blob-1"></div>
                        <div className="blob blob-2"></div>
                        <div className="blob blob-3"></div>
                    </div>

                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    <AuthModal isOpen={authModalOpen} onClose={() => setAuthModalOpen(false)} setUser={setUser} />
                    
                    <RegistrationModal 
                        isOpen={!!registeringClub} 
                        onClose={() => setRegisteringClub(null)} 
                        club={registeringClub}
                        onConfirm={confirmRegistration}
                        userProfile={userProfile}
                    />
                    
                    <ClubDetailsModal 
                        isOpen={!!viewingClub} 
                        onClose={() => setViewingClub(null)} 
                        club={viewingClub} 
                    />
                    
                    <ClubFormModal 
                        isOpen={clubModalOpen} 
                        onClose={() => { setClubModalOpen(false); setEditingClub(null); }} 
                        editData={editingClub}
                        onSave={handleSaveClub}
                    />
                    
                    <ProfileModal isOpen={profileModalOpen} onClose={() => setProfileModalOpen(false)} user={user} userProfile={userProfile} onUpdate={handleProfileUpdate} />

                    <MemberManagementModal isOpen={memberMgmtOpen} onClose={() => setMemberMgmtOpen(false)} onEditUser={handleAdminUpdateUser} onDeleteUser={handleAdminDeleteUser} />

                    <header className="bg-white/80 backdrop-blur-md shadow-sm border-b border-white/20 sticky top-0 z-40 transition-all">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-indigo-500 to-violet-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200/50">
                                    <School className="text-white w-6 h-6" />
                                </div>
                                <h1 className="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 tracking-tight hidden sm:block">新上國小課後社團</h1>
                                <h1 className="text-xl font-bold text-slate-800 sm:hidden">社團報名</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                {user ? (
                                    <div className="flex items-center gap-4">
                                        <div className="text-right hidden md:block cursor-pointer group" onClick={() => setProfileModalOpen(true)}>
                                            <div className="text-sm font-bold text-slate-700 flex items-center justify-end gap-1 group-hover:text-indigo-600 transition">
                                                {userProfile?.name || user.displayName || '家長'} <Edit size={14} className="text-slate-400 group-hover:text-indigo-400"/>
                                            </div>
                                            <div className="text-xs text-slate-500 flex items-center justify-end gap-1">
                                                {isAdmin && <Shield size={12} className="text-amber-500" />}
                                                {isAdmin ? '管理員' : (userProfile?.phone || '會員')}
                                            </div>
                                        </div>
                                        <button onClick={() => signOut(auth)} className="bg-white/50 border border-white/40 hover:bg-white hover:text-red-600 hover:shadow-md text-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2 backdrop-blur-sm">
                                            <LogOut size={16} /> <span className="hidden sm:inline">登出</span>
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => setAuthModalOpen(true)} className="bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg shadow-indigo-200/50 hover:shadow-indigo-200 hover:-translate-y-0.5 flex items-center gap-2 active:scale-[0.98]">
                                        <User size={18} /> 登入 / 註冊
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-10">
                        {isAdmin && (
                            <>
                                <section className="glass-card rounded-3xl overflow-hidden transition-shadow hover:shadow-2xl duration-300">
                                    <div className="bg-slate-800/95 px-8 py-5 flex justify-between items-center">
                                        <h2 className="text-lg font-bold flex items-center gap-2 text-white"><Settings size={20} className="text-indigo-400" /> 管理員設定</h2>
                                        <span className="text-xs bg-indigo-500/20 text-indigo-200 px-3 py-1 rounded-full border border-indigo-400/30 backdrop-blur-sm">Admin Mode</span>
                                    </div>
                                    <div className="p-8 space-y-8">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-2">
                                                <label className="block text-sm font-bold text-slate-600">報名開始時間</label>
                                                <input type="datetime-local" value={settings.start || ''} onChange={(e) => setSettings(s => ({...s, start: e.target.value}))} className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 focus:bg-white transition backdrop-blur-sm"/>
                                            </div>
                                            <div className="space-y-2">
                                                <label className="block text-sm font-bold text-slate-600">報名結束時間</label>
                                                <div className="flex gap-3">
                                                    <input type="datetime-local" value={settings.end || ''} onChange={(e) => setSettings(s => ({...s, end: e.target.value}))} className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 focus:bg-white transition backdrop-blur-sm"/>
                                                    <button onClick={() => handleUpdateSettings({ ...settings, manualOpen: null })} className="bg-indigo-600 text-white px-5 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200/50 active:scale-[0.98] whitespace-nowrap transition-all">儲存排程</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-4 pt-6 border-t border-slate-100/50">
                                            <button onClick={() => handleUpdateSettings({ ...settings, manualOpen: true })} className="bg-emerald-50 text-emerald-700 border border-emerald-200 px-5 py-2.5 rounded-xl font-bold hover:bg-emerald-100 flex items-center gap-2 transition shadow-sm"><CheckCircle size={18} /> 立即開放</button>
                                            <button onClick={() => handleUpdateSettings({ ...settings, manualOpen: false })} className="bg-slate-100 text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl font-bold hover:bg-slate-200 flex items-center gap-2 transition shadow-sm"><AlertTriangle size={18} /> 立即關閉</button>
                                            
                                            <button onClick={() => setMemberMgmtOpen(true)} className="bg-violet-50 text-violet-700 border border-violet-200 px-5 py-2.5 rounded-xl font-bold hover:bg-violet-100 flex items-center gap-2 transition shadow-sm"><Users size={18} /> 會員管理</button>
                                            
                                            <div className="flex-grow"></div>
                                            <button onClick={() => setClubModalOpen(true)} className="bg-gradient-to-r from-indigo-600 to-violet-600 text-white px-6 py-2.5 rounded-xl font-bold hover:shadow-lg hover:shadow-indigo-200/50 hover:-translate-y-0.5 flex items-center gap-2 transition-all active:scale-[0.98]"><Plus size={18} /> 新增社團</button>
                                        </div>
                                        <div className="bg-white/40 backdrop-blur-sm p-6 rounded-2xl border border-white/60 grid grid-cols-1 md:grid-cols-2 gap-6 shadow-inner">
                                            <div className="space-y-3">
                                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><FileSpreadsheet size={18} className="text-indigo-500"/> 社團資料管理</h3>
                                                <div className="flex gap-2 flex-wrap">
                                                    <button onClick={() => exportCSV('clubs')} className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 flex items-center gap-1.5 transition shadow-sm"><Download size={14}/> 匯出社團</button>
                                                    <input type="file" accept=".csv" ref={clubFileInputRef} onChange={(e) => handleFileUpload(e, 'clubs')} className="hidden" />
                                                    <button onClick={() => clubFileInputRef.current.click()} className="bg-white border border-purple-200 text-purple-600 px-4 py-2 rounded-lg text-sm hover:bg-purple-50 hover:border-purple-300 flex items-center gap-1.5 transition shadow-sm"><FileUp size={14}/> 匯入社團</button>
                                                    <button onClick={() => clearAllData('clubs')} className="bg-white border border-red-200 text-red-500 px-4 py-2 rounded-lg text-sm hover:bg-red-50 hover:border-red-300 flex items-center gap-1.5 transition ml-auto shadow-sm"><Trash2 size={14}/> 清空</button>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Users size={18} className="text-indigo-500"/> 報名資料管理</h3>
                                                <div className="flex gap-2 flex-wrap">
                                                    <button onClick={() => exportCSV('regs')} className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 flex items-center gap-1.5 transition shadow-sm"><Download size={14}/> 匯出報名</button>
                                                    <input type="file" accept=".csv" ref={regFileInputRef} onChange={(e) => handleFileUpload(e, 'regs')} className="hidden" />
                                                    <button onClick={() => regFileInputRef.current.click()} className="bg-white border border-purple-200 text-purple-600 px-4 py-2 rounded-lg text-sm hover:bg-purple-50 hover:border-purple-300 flex items-center gap-1.5 transition shadow-sm"><FileUp size={14}/> 匯入報名</button>
                                                    <button onClick={() => clearAllData('regs')} className="bg-white border border-red-200 text-red-500 px-4 py-2 rounded-lg text-sm hover:bg-red-50 hover:border-red-300 flex items-center gap-1.5 transition ml-auto shadow-sm"><Trash2 size={14}/> 清空</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <section className="glass-card rounded-3xl overflow-hidden transition-shadow hover:shadow-2xl duration-300">
                                    <div className="px-8 py-5 border-b border-slate-200/60 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4">
                                        <div className="flex items-center gap-4">
                                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                                <List size={22} className="text-indigo-500" /> 報名情形總覽
                                            </h2>
                                            <span className="text-sm text-slate-500 bg-white/60 border border-white px-3 py-1 rounded-full shadow-sm backdrop-blur-sm">
                                                {formattedTime} 更新 • 共 {filteredAdminRegs.length} 筆
                                            </span>
                                            <button onClick={handleManualRefresh} className="text-slate-400 hover:text-indigo-600 transition p-1.5 rounded-full hover:bg-white/50" title="重新整理">
                                                <RefreshCw size={18} />
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2 w-full sm:w-auto bg-white/60 p-1.5 rounded-xl border border-white/50 shadow-sm backdrop-blur-sm">
                                            <Filter size={16} className="text-slate-400 ml-2" />
                                            <select 
                                                value={adminRegFilter} 
                                                onChange={(e) => setAdminRegFilter(e.target.value)}
                                                className="border-none text-sm focus:ring-0 outline-none flex-grow sm:w-64 bg-transparent text-slate-700 font-medium"
                                            >
                                                <option value="all">全部社團 ({registrations.length}筆)</option>
                                                {clubs.map(c => (
                                                <option key={c.id} value={c.id}>
                                                    {c.name} ({getClubStats(c.id).mainCount + getClubStats(c.id).reserveCount}人)
                                                </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto max-h-[500px] overflow-y-auto custom-scrollbar">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="bg-slate-50/80 text-slate-500 uppercase text-xs font-bold sticky top-0 z-10 backdrop-blur-md shadow-sm">
                                                <tr>
                                                    <th className="px-6 py-4 tracking-wider">社團名稱</th>
                                                    <th className="px-6 py-4 tracking-wider">學生班級</th>
                                                    <th className="px-6 py-4 tracking-wider">學生姓名</th>
                                                    <th className="px-6 py-4 tracking-wider">家長姓名</th>
                                                    <th className="px-6 py-4 tracking-wider">電話</th>
                                                    <th className="px-6 py-4 tracking-wider">狀態</th>
                                                    <th className="px-6 py-4 text-right tracking-wider">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100/50 bg-white/30">
                                                {filteredAdminRegs.length === 0 ? (
                                                    <tr><td colSpan="7" className="px-6 py-16 text-center text-slate-400">無符合條件的報名資料</td></tr>
                                                ) : (
                                                    filteredAdminRegs.map(reg => (
                                                        <tr key={reg.id} className="hover:bg-white/60 transition-colors group">
                                                            <td className="px-6 py-4 font-bold text-slate-800">{reg.clubName}</td>
                                                            <td className="px-6 py-4 text-slate-600">{reg.studentClass}</td>
                                                            <td className="px-6 py-4 text-slate-600 font-medium">{reg.studentName}</td>
                                                            <td className="px-6 py-4 text-sm text-slate-500">{reg.parentName}</td>
                                                            <td className="px-6 py-4 text-sm text-slate-500">{reg.parentPhone}</td>
                                                            <td className="px-6 py-4">
                                                                <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${
                                                                    reg.status === 'main' 
                                                                    ? 'bg-emerald-50 text-emerald-700 border-emerald-100' 
                                                                    : 'bg-amber-50 text-amber-700 border-amber-100'
                                                                }`}>
                                                                    {getStatusLabel(reg)}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 text-right">
                                                                <button 
                                                                    onClick={() => handleCancelRegistration(reg.id)}
                                                                    className="text-slate-300 hover:text-rose-600 hover:bg-rose-50 p-2 rounded-lg transition" 
                                                                    title="刪除報名"
                                                                >
                                                                    <Trash2 size={18} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </>
                        )}

                        <div className={`p-6 rounded-3xl border shadow-lg flex items-center justify-between transition-all duration-500 ${
                            isRegistrationOpen 
                            ? 'bg-gradient-to-r from-emerald-50 to-teal-50 border-emerald-100 text-emerald-800' 
                            : 'bg-gradient-to-r from-slate-100 to-gray-100 border-slate-200 text-slate-600'
                        }`}>
                            <div className="flex items-center gap-5">
                                <div className={`p-4 rounded-full shadow-sm ${isRegistrationOpen ? 'bg-white text-emerald-500' : 'bg-white text-slate-400'}`}>
                                    <Clock size={32} />
                                </div>
                                <div>
                                    <h3 className="font-black text-2xl tracking-tight">{isRegistrationOpen ? '目前開放報名中' : '目前非報名時間'}</h3>
                                    <p className="text-sm opacity-80 mt-1 font-medium tracking-wide">
                                        {settings.start && settings.end ? `${settings.start.replace('T', ' ')} ~ ${settings.end.replace('T', ' ')}` : '尚未設定時間'}
                                    </p>
                                </div>
                            </div>
                            {isRegistrationOpen && <Sparkles className="text-emerald-400 animate-pulse hidden sm:block" size={48} strokeWidth={1} />}
                        </div>

                        {user && !isAdmin && (
                            <section className="glass-card rounded-3xl overflow-hidden transition-shadow hover:shadow-2xl duration-300">
                                <div className="px-8 py-6 border-b border-slate-200/60 bg-indigo-50/30 flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-4">
                                        <h2 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
                                            <List size={24} className="text-indigo-600" /> 我的報名清單
                                        </h2>
                                        <span className="text-sm text-indigo-600 bg-white/60 border border-white px-3 py-1 rounded-full font-medium shadow-sm backdrop-blur-sm">
                                            {formattedTime} 更新 • 共 {userRegistrations.length} 筆
                                        </span>
                                        <button onClick={handleManualRefresh} className="text-indigo-300 hover:text-indigo-600 transition p-1.5 rounded-full hover:bg-white/50" title="重新整理">
                                            <RefreshCw size={18} />
                                        </button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-50/50 text-slate-500 uppercase text-xs font-bold">
                                            <tr>
                                                <th className="px-6 py-5 tracking-wider">社團名稱</th>
                                                <th className="px-6 py-5 tracking-wider">學生班級</th>
                                                <th className="px-6 py-5 tracking-wider">學生姓名</th>
                                                <th className="px-6 py-5 tracking-wider">狀態</th>
                                                <th className="px-6 py-5 text-right tracking-wider">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100/50 bg-white/40">
                                            {userRegistrations.length === 0 ? (
                                                <tr>
                                                    <td colSpan="5" className="px-6 py-16 text-center text-slate-400 italic">
                                                        目前沒有報名任何社團
                                                    </td>
                                                </tr>
                                            ) : (
                                                userRegistrations.map(reg => (
                                                    <tr key={reg.id} className="hover:bg-white/60 transition-colors group">
                                                        <td className="px-6 py-5 font-bold text-slate-800">{reg.clubName}</td>
                                                        <td className="px-6 py-5 text-slate-600">{reg.studentClass}</td>
                                                        <td className="px-6 py-5 text-slate-600 font-medium">{reg.studentName}</td>
                                                        <td className="px-6 py-5">
                                                            <span className={`px-3 py-1.5 rounded-full text-xs font-bold border shadow-sm ${
                                                                reg.status === 'main' 
                                                                ? 'bg-emerald-50 text-emerald-700 border-emerald-100' 
                                                                : 'bg-amber-50 text-amber-700 border-amber-100'
                                                            }`}>
                                                                {getStatusLabel(reg)}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-5 text-right">
                                                            <button 
                                                                onClick={() => handleCancelRegistration(reg.id)}
                                                                className="text-slate-300 hover:text-rose-600 hover:bg-rose-50 p-2.5 rounded-xl transition"
                                                                title="取消報名"
                                                            >
                                                                <XCircle size={20} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        )}

                        <section className="glass-card rounded-3xl overflow-hidden transition-shadow hover:shadow-2xl duration-300">
                            <div className="px-8 py-6 border-b border-slate-200/60 flex justify-between items-center bg-white/30">
                                <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Users size={26} className="text-indigo-600"/> 所有社團列表</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-50/50 text-slate-500 uppercase text-xs font-bold">
                                        <tr>
                                            <th className="px-6 py-5 tracking-wider">社團名稱</th>
                                            <th className="px-6 py-5 tracking-wider">老師</th>
                                            <th className="px-6 py-5 tracking-wider">時間</th>
                                            <th className="px-6 py-5 tracking-wider">地點</th>
                                            <th className="px-6 py-5 tracking-wider">年級</th>
                                            <th className="px-6 py-5 tracking-wider">費用 (學+材)</th>
                                            <th className="px-6 py-5 text-center tracking-wider">名額 (正/備)</th>
                                            <th className="px-6 py-5 text-center tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100/50 bg-white/40 backdrop-blur-sm">
                                        {clubs.length === 0 ? (
                                            <tr><td colSpan="8" className="px-6 py-24 text-center text-slate-400 text-lg bg-white/20">目前尚無社團資料，請等待管理員新增。</td></tr>
                                        ) : (
                                            clubs.map((club) => {
                                                const { mainCount, reserveCount } = getClubStats(club.id);
                                                const isFull = mainCount >= club.quota && reserveCount >= club.reserveQuota;
                                                return (
                                                    <tr key={club.id} className="hover:bg-white/80 transition-colors group">
                                                        <td className="px-6 py-5">
                                                            <div className="font-bold text-indigo-900 text-lg tracking-tight">{club.name}</div>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-600 font-medium">{club.teacher}</td>
                                                        <td className="px-6 py-5 text-sm text-slate-600">
                                                            <div className="flex items-center gap-2"><Clock size={16} className="text-slate-400"/>{club.time}</div>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-600">
                                                           <div className="flex items-center gap-2"><MapPin size={16} className="text-slate-400"/>{club.location}</div>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-600">
                                                            <span className="bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm">{club.grade}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-700 font-medium">
                                                            ${club.fee} <span className="text-slate-400 text-xs">+ ${club.materialFee}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-center">
                                                            <div className="flex flex-col items-center gap-1.5 text-sm">
                                                                <div className="flex items-center gap-1.5">
                                                                    <span className={`font-bold ${mainCount >= club.quota ? 'text-rose-500' : 'text-emerald-600'}`}>{mainCount}/{club.quota}</span>
                                                                    <span className="text-[10px] uppercase tracking-wider text-slate-400 font-bold">正</span>
                                                                </div>
                                                                <div className="flex items-center gap-1.5">
                                                                    <span className={`font-bold ${reserveCount >= club.reserveQuota ? 'text-rose-500' : 'text-amber-500'}`}>{reserveCount}/{club.reserveQuota}</span>
                                                                    <span className="text-[10px] uppercase tracking-wider text-slate-400 font-bold">備</span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5 text-center">
                                                            <div className="flex items-center justify-center gap-3">
                                                                <button onClick={() => setViewingClub(club)} className="p-2.5 bg-white border border-slate-200 text-slate-500 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm hover:shadow-md" title="查看詳情"><Info size={20} /></button>

                                                                {isAdmin ? (
                                                                    <>
                                                                    <button onClick={() => { setEditingClub(club); setClubModalOpen(true); }} className="p-2.5 bg-white border border-slate-200 text-indigo-600 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 transition-all shadow-sm hover:shadow-md"><Edit size={20}/></button>
                                                                    <button onClick={() => handleDeleteClub(club.id)} className="p-2.5 bg-white border border-slate-200 text-rose-600 rounded-xl hover:bg-rose-50 hover:border-rose-200 transition-all shadow-sm hover:shadow-md"><Trash2 size={20}/></button>
                                                                    </>
                                                                ) : (
                                                                    <button 
                                                                        onClick={() => handleRegisterClick(club)} 
                                                                        disabled={!isRegistrationOpen || isFull} 
                                                                        className={`px-6 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg hover:shadow-xl active:scale-[0.98] flex items-center gap-2 ${
                                                                            !isRegistrationOpen 
                                                                            ? 'bg-slate-100 text-slate-400 cursor-not-allowed border border-slate-200 shadow-none' 
                                                                            : isFull 
                                                                                ? 'bg-slate-200 text-slate-500 cursor-not-allowed border border-slate-300 shadow-none' 
                                                                                : 'bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white shadow-indigo-200'
                                                                        }`}
                                                                    >
                                                                        {isFull ? '已額滿' : <>報名 <ChevronRight size={16}/></>}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </main>
                    <footer className="mt-20 py-10 text-center text-slate-500 text-sm font-medium relative z-10">
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
                        <p>© {new Date().getFullYear()} 新上國小課後社團報名系統</p>
                        <p className="text-xs mt-2 text-slate-400">System Designed for Demo</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        document.body.style.display = 'block';
    </script>
</body>
</html>